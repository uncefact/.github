name: jargon_onSnapshot

on:
  workflow_call:
    
env:
  # Setting an environment variable with the value of a configuration variable
  domain_name: ${{ github.event.client_payload.domain.name }}
  prefix: ${{ github.event.client_payload.settings.jsonld.prefix }}

jobs:
  merge:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v3
        with:
          ref: data-models-staging
          token: ${{ secrets.PAT_TOKEN }}
      - run: 'echo "Domain name: ${{ env.domain_name }}"'

      - run: 'echo "client_payload: ${{ github.event.client_payload }}"'

      - shell: bash
        env:
          CLIENT_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          printf '%s\n' "$CLIENT_PAYLOAD" > client_payload.json
          cat client_payload.json
          rm client_payload.json
      
      - working-directory: "data-models/"
        run: '[ -d ${{ env.prefix }} ] || mkdir ${{ env.prefix }}'
      
      - working-directory: "data-models/${{ env.prefix }}"
        run: '[ -d artefacts ] || mkdir artefacts'

      - working-directory: "data-models/"
        run: 'ls -la'
      - working-directory: "data-models/${{ env.prefix }}/"
        run: |
          wget -O jargon.json ${{ github.event.client_payload.artefacts.jsonldVocab.url }}
          wget -O artefacts/context.json ${{ github.event.client_payload.artefacts.jsonldContext.url }}
          wget -O artefacts/schema.json ${{ github.event.client_payload.artefacts.jsonSchemas[0].url }}
          wget -O artefacts/sample.json ${{ github.event.client_payload.artefacts.jsonSchemas[1].url }}
      
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: sync data model with Jargon snapshot ${{ github.event.client_payload.snapshot.index }}'
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          signoff: false
          branch: feature/jargon-sync-${{ github.event.client_payload.snapshot.index }}
          delete-branch: true
          title: 'chore: sync data model with Jargon snapshot ${{ github.event.client_payload.snapshot.index }}'
          body: |
            sync data model with Jargon snapshot ${{ github.event.client_payload.snapshot.index }}
          draft: false
